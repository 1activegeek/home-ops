---
# Phase 4: Envoy Gateway SecurityPolicy for Authentik forward-auth
# This policy enables external authentication via Authentik's embedded outpost
#
# NOTE: This policy targets specific HTTPRoutes (not the entire Gateway)
# to allow some routes (auth.*, echo.*) to remain public.
#
# Services protected by this policy:
#   - hass.thegeekybits.com (Home Assistant)
#   - hass-code.thegeekybits.com (Code Server)
#   - hass-esphome.thegeekybits.com (ESPHome)
#   - hass-zwave.thegeekybits.com (Z-Wave JS UI)
#
# Services NOT protected (public):
#   - auth.thegeekybits.com (Authentik itself - must be public for login)
#   - echo.thegeekybits.com (test app - user requested public)
#
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: authentik-forward-auth
  namespace: network
spec:
  # Target specific routes that need authentication
  # Each protected external HTTPRoute should be listed here
  targetRefs:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: home-assistant-external
      namespace: home
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: code-server-external
      namespace: home
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: esphome-external
      namespace: home
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      name: zwave-js-ui-external
      namespace: home
  extAuth:
    http:
      backendRefs:
        - name: authentik-server
          namespace: security
          port: 80
      # Authentik's embedded outpost forward-auth endpoint
      path: /outpost.goauthentik.io/auth/envoy
      # Headers to send to Authentik for authentication decision
      headersToBackend:
        - X-Forwarded-Proto
        - X-Forwarded-Host
        - X-Forwarded-Uri
        - X-Forwarded-For
        - Cookie

---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: zwave-js-ui
spec:
  chartRef:
    kind: OCIRepository
    name: zwave-js-ui
  interval: 1h
  values:
    controllers:
      zwave-js-ui:
        type: statefulset
        containers:
          app:
            image:
              repository: ghcr.io/zwave-js/zwave-js-ui
              tag: 9.31.0
            env:
              TZ: America/New_York
            resources:
              requests:
                cpu: 50m
                memory: 256Mi
              limits:
                memory: 512Mi
            # Uncomment for USB access
            # securityContext:
            #   privileged: true

    # Uncomment and set hostname when USB device is attached
    # defaultPodOptions:
    #   nodeSelector:
    #     kubernetes.io/hostname: <node-with-zwave>

    service:
      app:
        controller: zwave-js-ui
        ports:
          http:
            port: 8091
          websocket:
            port: 3000

    persistence:
      config:
        type: persistentVolumeClaim
        storageClass: longhorn
        accessMode: ReadWriteOnce
        size: 1Gi
        globalMounts:
          - path: /usr/src/app/store
      # Uncomment for Z-Wave USB device
      # zwave-usb:
      #   type: hostPath
      #   hostPath: /dev/serial/by-id/<zwave-device-id>
      #   globalMounts:
      #     - path: /dev/zwave

    route:
      app:
        hostnames: ["hass-zwave.${SECRET_DOMAIN}"]
        parentRefs:
          - name: envoy-internal
            namespace: network
            sectionName: https
        rules:
          - backendRefs:
              - identifier: app
                port: 8091

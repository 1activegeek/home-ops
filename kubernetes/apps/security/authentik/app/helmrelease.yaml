---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: authentik
spec:
  chart:
    spec:
      chart: authentik
      version: 2025.10.0
      sourceRef:
        kind: HelmRepository
        name: authentik
  interval: 1h
  timeout: 15m
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  valuesFrom:
    - kind: Secret
      name: authentik-secrets
      valuesKey: AUTHENTIK_SECRET_KEY
      targetPath: authentik.secret_key
    - kind: Secret
      name: authentik-secrets
      valuesKey: AUTHENTIK_DB_PASSWORD
      targetPath: authentik.postgresql.password
    - kind: Secret
      name: authentik-secrets
      valuesKey: AUTHENTIK_DB_PASSWORD
      targetPath: postgresql.auth.password
    - kind: Secret
      name: authentik-secrets
      valuesKey: AUTHENTIK_DB_PASSWORD
      targetPath: postgresql.auth.postgresPassword
  values:
    worker:
      replicas: 1

    # Authentik Core Configuration
    authentik:
      log_level: info
      email:
        host: smtp.example.com
        port: 25
        username: ""
        password: ""
        use_tls: false
        use_ssl: false
        timeout: 30
        from_address: authentik@example.com

    # Authentik Server Configuration
    server:
      replicas: 2
    route:
      main:
        enabled: true
        hostnames:
          - "{{ .Release.Name }}.${SECRET_DOMAIN}"
          - auth.$SECRET_DOMAIN
        parentRefs:
          - name: envoy-internal
            namespace: network
            sectionName: https
        https: true

    # Authentik Worker Configuration
    worker:
      replicas: 1

    # PostgreSQL Database Configuration
    postgresql:
      enabled: true
      auth:
        username: authentik
        database: authentik
      primary:
        persistence:
          enabled: true
          storageClass: longhorn
          size: 25Gi
          accessModes:
            - ReadWriteOnce

    # # Redis Cache Configuration - should be deprecated and not required
    # redis:
    #   enabled: true
    #   auth:
    #     enabled: false
    #   master:
    #     persistence:
    #       enabled: true
    #       storageClass: longhorn
    #       size: 5Gi
